---
title: "Chignik Sockeye Inseason 2020"
output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Purpose

This inseason analysis serves two purposes:  

  1) Analyze 2020 inseason samples against the new baseline (2018) with 16 populations and the 2 new RAD loci,
  2) Provide historical perspecitve (i.e. compare to previous years 2010-2019) .
  
The *BAYES* baseline update was described in `../../../Baseline/2018/`

This *R Notebook* will perform the following tasks:  

  * Setup 2020 and import files from 2019
  * Import genotypes
  * Create mixture strata
  * Data QA
  * Mixture anlaysis with *BAYES*
  * Summarise mixture output
  * Save workspace for separate *R markdown* file that creates final report

# Background

This project estimates the stock composition of early- and late-run sockeye salmon through the Chignik weir to estimate the transition between the two runs in the escapement.

*NOTE* This notebook is using the **old** GCL functions from the  `v1.12.0-static` branch!!!

# Setup

Load packages and source GCL functions.
```{r load_source}
rm(list = ls())

library(tidyverse)
library(lubridate)
library(rubias)
library(ggthemes)
library(gridExtra)
library(ggpubr)
# library(conflicted)

source("~/../R/Functions.GCL.R")
.username = "krshedd"
.password = ""


load_objects(path = "../../2020/Objects")
# load_objects(path = "../../2020/rubias/baseline")
```

# Prep 2020

## Create directories

```{r 2019_dirs}
(dirs_2019 <- list.dirs(path = "../../2019", full.names = FALSE, recursive = FALSE))
```

```{r 2020_main_dirs}
# dir.create("../../2020")

dirs_2020 <- paste0("../../2020/", dirs_2019[c(1:3, 5:14)])
sapply(dirs_2020, dir.create)
```

```{r 2020_sub_dirs}
dir.create("../../2020/Raw genotypes/Strata")

dirs_rubias_2020 <- paste0("../../2020/rubias/", c("baseline", "mixture", "output"))
sapply(dirs_rubias_2020, dir.create)

dirs_BAYES_2020 <- paste0("../../2020/BAYES/", c("Baseline", "Control", "Mixture", "Output"))
sapply(dirs_BAYES_2020, dir.create)
```

## Copy 2019 files

```{r BAYES_baseline_objects_copy_paste}
baseline_objects_2018 <- list.files(path = "../../../Baseline/2018/Objects/", pattern = ".txt", full.names = TRUE)[-c(6:7)]

file.copy(from = baseline_objects_2018, to = "../../2020/Objects/")
```

```{r BAYES_baseline_copy_paste}
file.copy(from = "../../../Baseline/2018/BAYES/Baseline/Chignik16pops22RAD.bse", 
          to = "../../2020/BAYES/Baseline/")
```

```{r 2019_objects_copy_paste}
objects_2019 <- c("../../2019/Objects/chignik_colors.txt",
                  "../../2019/Objects/Inits_16pops.txt",
                  "../../2019/Objects/loci24_RAD.txt",
                  "../../2019/Objects/WASSIPSockeyeSeeds.txt")

file.copy(from = objects_2019, to = "../../2020/Objects/")
```

```{r 2019_estimates_copy_paste}
estimates_objects_2019 <- list.files(path = "../../2019/Estimates objects/", pattern = "chignik_2019_dates", full.names = TRUE)

file.copy(from = estimates_objects_2019, to = "../../2020/Estimates objects/")
```


```{r 2019_estimates_csv_copy_paste}
estimates_csv_objects_2019 <- list.files(path = "../../2019/Estimates tables/", full.names = TRUE)

file.copy(from = estimates_csv_objects_2019, to = "../../2020/Estimates tables/")
```

```{r}
baseline_genotypes <- list.files(path = "../../2019/Baseline genotypes/", full.names = TRUE)

file.copy(from = baseline_genotypes, to = "../../2020/Baseline genotypes/")
```

```{r}
rubias_baseline <- list.files(path = "../../2019/rubias/baseline/", full.names = TRUE)

file.copy(from = rubias_baseline, to = "../../2020/rubias/baseline/")
```


```{r}
file.copy(from = "../../2019/sample_size_qa_baseline.csv", to = "../../2020")
```


# Average model 2010-2019

From Lukas and Dan Schindler's code with 2010-2019 data and `preseason = TRUE`
```{r}
stan_model <- read_csv("V:/Documents/4_Westward/Sockeye/Chignik GSI Inseason Model - Schindler/bayesian_hierarchical_transition_model/current_year_curves.csv") %>% 
  rename(julian = X1, chignik_late_prop = V1) %>% 
  mutate(date = as.Date(julian, origin = "2019-12-31")) %>% 
  select(julian, date, chignik_late_prop) %>% 
  write_csv(path = "../../2020/2020_preseason_average_GSI_model_stan.csv")
```


# Run 1

Find and replace "run1"
```{r run1_setup}
sillys <- "SCHIG20"
strata <- 1
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Create LocusControl

```{r 2020_locuscontrol}
CreateLocusControl.GCL(locusnames = loci24_RAD, username = .username, password = .password)
save_objects("LocusControl", path = "../../2020/Objects/")
```

## Read genotypes

Sample size should be multiples of 190.
```{r run1_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run1_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1, 
                       begin_date = as.Date(x = c("2020-06-29")), 
                       end_date = as.Date(x = c("2020-07-01")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run1_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run1_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run1_n_locus)
round(apply(original_sillys_strata_2020_run1_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run1_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2020_run1}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run1}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run1}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run1}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run1}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run1}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Prior

```{r}
mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv")

mod_avg <- mod_avg %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y"))

chignik_late_prior_1 <- mod_avg %>%
  filter(date == as.Date("2020-06-30")) %>% 
  pull(chignik_late_prop_adfg)
```

```{r prior_run1}
chignik_2020_start_prior_weights <- c(1 - chignik_late_prior_1, chignik_late_prior_1)

chignik_1_2020_prior <- 
  Prior.GCL(
    groupvec = groupvec16, 
    groupweights = chignik_2020_start_prior_weights, 
    minval = 0.01
  )
save_objects(objects = "chignik_1_2020_prior", path = "../../2020/Objects")
```

### Control files

```{r control_run1}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_1_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run1}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run1}
SCHIG20_1_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_1_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run1}
trace_plot.f <- function(estimate_obj) {
  par(mfrow = c(2, 1), mar = c(4.1, 4.1, 2.1, 2.1))
  
  plot(estimate_obj[[2]][[1]][seq(from = 1, to = 100000, by = 10), 1], type = "l", ylim = c(0, 1), ylab = "", main = "Black Lake", xlab = "")
  abline(v = seq(from = 0, to = 10000, by = 2000))
  par(mar = c(4.1, 4.1, 2.1, 2.1))
  plot(estimate_obj[[2]][[1]][seq(from = 1, to = 100000, by = 10), 2], type = "l", ylim = c(0, 1), ylab = "", main = "Chignik Lake", xlab = "Repetitions", cex.lab = 1.2)
  abline(v = seq(from = 0, to = 10000, by = 2000))
  mtext(text = "Posterior", side = 2, outer = TRUE, line = -1, cex = 1.2)
  
  print(estimate_obj[[1]][[1]][, "GR"])
}

save_objects(objects = "trace_plot.f", path = "../../2020/Objects/")
trace_plot.f(estimate_obj = SCHIG20_1_estimates)
```

Add to summary
```{r summary_run1}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run1}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run1}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run1}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run1}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run2}
chignik_2_2020_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG20_1_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_2_2020_prior", path = "../../2020/Objects/")
```

## Save
```{r save_run1}
save.image("../../2020/chignik_2020_run1.RData")
```

## Individual Assignment

Need to remove the two individuals with unrecognized alleles, otherwise the function won't work.
```{r}
ids_2_remove <- SCHIG20_1.gcl$attributes$FK_FISH_ID[c(60, 145)]

RemoveIDs.GCL(silly = "SCHIG20_1", IDs = ids_2_remove)

SCHIG20_1.gcl$n
```

First 96 fish were from 6/29, next 94 were from 7/1.
```{r}
(
  chignik_1_2020_IA <-
    IndividualAssignmentSummary.GCL(
      GroupNames = ChignikGroups,
      groupvec = groupvec16,
      mixnames = sillys_strata_2020,
      BAYESoutputDir = "../../2020/BAYES/Output/",
      nchains = 5,
      nreps = 40000,
      burn = 0.5,
      thin = 100
    )
)
```

Most likely group based on sample date.
```{r}
chignik_1_2020_IA$SCHIG20_1 %>% 
  as_tibble(rownames = "fish_id") %>% 
  mutate(fish_id = as.numeric(fish_id)) %>% 
  mutate(group = case_when(`Black Lake` > `Chignik Lake` ~ "early",
                           TRUE ~ "late")) %>% 
  mutate(date = case_when(fish_id < 97 ~ "6/19",
                          TRUE ~ "7/01")) %>% 
  count(group, date) %>% 
  spread(date, n)
```


# Run 2

Find and replace "run2"
```{r run2_setup}
sillys <- "SCHIG20"
strata <- 2
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run2_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run2_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2020-06-29", "2020-07-06")), 
                       end_date = as.Date(x = c("2020-07-01", "2020-07-06")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run2_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run2_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run2_n_locus)
round(apply(original_sillys_strata_2020_run2_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run2_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2020_run2}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run2}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run2}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run2}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run2}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run2}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Control files

```{r control_run2}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_2_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run2}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run2}
SCHIG20_2_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_2_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run2}
trace_plot.f(estimate_obj = SCHIG20_2_estimates)
```

Add to summary
```{r summary_run2}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run2}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run2}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run2}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run2}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run3}
chignik_3_2020_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG20_2_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_3_2020_prior", path = "../../2020/Objects/")
```

## Save
```{r save_run2}
save.image("../../2020/chignik_2020_run2.RData")
```

# Run 3

Find and replace "run3"
```{r run3_setup}
sillys <- "SCHIG20"
strata <- 3
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run3_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run3_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2020-06-29", "2020-07-06", "2020-07-11")), 
                       end_date = as.Date(x = c("2020-07-01", "2020-07-06", "2020-07-12")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run3_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run3_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run3_n_locus)
round(apply(original_sillys_strata_2020_run3_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run3_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2020_run3}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run3}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run3}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run3}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run3}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run3}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Control files

```{r control_run3}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_3_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run3}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      silly == "SCHIG20_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run3}
SCHIG20_3_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_3_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run3}
trace_plot.f(estimate_obj = SCHIG20_3_estimates)
```

Add to summary
```{r summary_run3}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run3}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run3}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run3}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run3}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run4}
chignik_4_2020_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG20_3_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_4_2020_prior", path = "../../2020/Objects/")
```

## Save
```{r save_run3}
save.image("../../2020/chignik_2020_run3.RData")
```

# Run 4

Find and replace "run4"
```{r run4_setup}
sillys <- "SCHIG20"
strata <- 4
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run4_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run4_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2020-06-29", "2020-07-06", "2020-07-11", "2020-07-17")), 
                       end_date = as.Date(x = c("2020-07-01", "2020-07-06", "2020-07-12", "2020-07-17")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run4_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run4_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run4_n_locus)
round(apply(original_sillys_strata_2020_run4_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run4_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2020_run4}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run4}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run4}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run4}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run4}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run4}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Control files

```{r control_run4}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_4_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run4}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      silly == "SCHIG20_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run4}
SCHIG20_4_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_4_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run4}
trace_plot.f(estimate_obj = SCHIG20_4_estimates)
```

Add to summary
```{r summary_run4}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run4}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run4}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run4}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run4}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run5}
chignik_5_2020_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG20_4_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_5_2020_prior", path = "../../2020/Objects/")
```

## Save
```{r save_run4}
save.image("../../2020/chignik_2020_run4.RData")
```

# Run 5

Find and replace "run5"
```{r run5_setup}
sillys <- "SCHIG20"
strata <- 5
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run5_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run5_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2020-06-29", "2020-07-06", "2020-07-11", "2020-07-17", "2020-07-23")), 
                       end_date = as.Date(x = c("2020-07-01", "2020-07-06", "2020-07-12", "2020-07-17", "2020-07-23")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run5_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run5_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run5_n_locus)
round(apply(original_sillys_strata_2020_run5_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run5_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2020_run5}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run5}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run5}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run5}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run5}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run5}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Control files

```{r control_run5}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_5_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run5}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      silly == "SCHIG20_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run5}
SCHIG20_5_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_5_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run5}
trace_plot.f(estimate_obj = SCHIG20_5_estimates)
```

Add to summary
```{r summary_run5}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run5}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run5}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run5}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run5}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run6}
chignik_6_2020_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG20_5_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_6_2020_prior", path = "../../2020/Objects/")
```

## Save
```{r save_run5}
save.image("../../2020/chignik_2020_run5.RData")
```

# Run 6

Find and replace "run6"
```{r run6_setup}
sillys <- "SCHIG20"
strata <- 6
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run6_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2020/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run6_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2020.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2020-06-29", "2020-07-06", "2020-07-11", "2020-07-17", "2020-07-23", "2020-08-01")), 
                       end_date = as.Date(x = c("2020-07-01", "2020-07-06", "2020-07-12", "2020-07-17", "2020-07-23", "2020-08-01")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2020.df, loci = loci24_RAD)

# Save
sillys_strata_2020 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2020", path = "../../2020/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2020/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run6_QA_loci}
## Get sample size by locus
original_sillys_strata_2020_run6_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2020_run6_n_locus)
round(apply(original_sillys_strata_2020_run6_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2020_run6_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2020_run6}
sillys_strata_2020_n <- tibble(silly = sillys_strata_2020) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2020_run6}
sillys_strata_2020_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2020, proportion = 0.8)
save_objects("sillys_strata_2020_MissLoci", "../../2020/Objects/")

# show individuals removed
sillys_strata_2020_MissLoci[sillys_strata_2020_MissLoci != "None"]

sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2020_run6}
sillys_strata_2020_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2020,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2020_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2020, function(x)
    sillys_strata_2020_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2020_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2020_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2020_DuplicateCheckReportSummary", "sillys_strata_2020_RemovedDups"),
  "../../2020/Objects/"
)

# show individuals removed
sillys_strata_2020_RemovedDups[sillys_strata_2020_RemovedDups != "Nothing Removed"]

sillys_strata_2020_n <- sillys_strata_2020_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2020_run6}
(sillys_strata_2020_n <- sillys_strata_2020_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run6}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run6}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2020/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2020/Objects")
```

### Control files

```{r control_run6}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_6_2020_prior, 
  initmat = Inits_16pops, 
  dir = "../../2020/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2020/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run6}
(
  sillys_strata_2020_n <- sillys_strata_2020_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG20_1" ~ as.integer(final - 2),
      silly == "SCHIG20_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2020_n", path = "../../2020/Objects/")
write_csv(sillys_strata_2020_n, "../../2020/Tables/sillys_strata_2020_n.csv")
```


```{r estimates_run6}
SCHIG20_6_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG20_6_estimates", path = "../../2020/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run6}
trace_plot.f(estimate_obj = SCHIG20_6_estimates)
```

Add to summary
```{r summary_run6}
SCHIG20_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2020/BAYES/Output", 
    mixvec = sillys_strata_2020,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG20_estimates", path = "../../2020/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run6}
chignik_2020.bayes <- bind_rows(sapply(sillys_strata_2020, function(mix) {
  as_tibble(cbind(SCHIG20_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run6}
SCHIG20_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2020, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG20_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run6}
chignik_2020_dates.bayes <- chignik_2020.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2019-12-31")) %>% 
  left_join(date_2020.df, by = "strata")

save_objects(objects = "chignik_2020_dates.bayes", path = "../../2020/Estimates objects/")
write_csv(x = chignik_2020_dates.bayes, path = "../../2020/Estimates tables/Chignik 2020 BAYES Estimates.csv")
```

```{r model_average_run6}
(mod_avg <- read_csv(file = "../../2020/2020_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```

## Save
```{r save_run6}
save.image("../../2020/chignik_2020_run6.RData")
```

