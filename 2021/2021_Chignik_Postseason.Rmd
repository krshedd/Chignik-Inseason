---
title: "Chignik Sockeye Postseason 2020"
author: "Kyle Shedd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
  output:
  html_notebook:
    theme: united
    toc: yes
editor_options: 
  chunk_output_type: inline
---

# Purpose

This **postseason** analysis serves two purposes:  

  1) Analyze the "traditional" six strata of samples from 2021 postseason against the new baseline (2020) with 16 populations and the 2 new RAD loci,
  2) Provide historical perspective (i.e. compare to previous years 2010-2020) .
  
The *BAYES* baseline update was described in `../../../Baseline/2020/`

This *R Notebook* will perform the following tasks:  

  * Setup 2021 and import files from 2020
  * Import genotypes
  * Create mixture strata
  * Data QA
  * Mixture anlaysis with *BAYES*
  * Summarise mixture output
  * Save workspace for separate *R markdown* file that creates final report

# Background

This project estimates the stock composition of early- and late-run sockeye salmon through the Chignik weir to estimate the transition between the two runs in the escapement.

In 2021 regional staff decided to have this project run post-season, rather than inseason.

CRAA is paying for the 2021 analyses via co-op agreement.

There will be a 7th sample taken in August to verify the 100% Late in August assumption, however, we will run set 1-6 first, then set 7 later.

Even though we are running sets 1-6 all together, I'm still going to run each one individually for rolling priors...

*NOTE* This notebook is using the **old** GCL functions from the  `v1.12.0-static` branch!!!

# Setup

Load packages and source GCL functions.
```{r load_source}
rm(list = ls())

library(tidyverse)
library(lubridate)
library(rubias)
library(ggthemes)
library(gridExtra)
library(ggpubr)
# library(conflicted)

source("~/../R/Functions.GCL.R")
username = readLines("~/../R/usr_pw.txt", n = 1)
.password = readLines("~/../R/usr_pw.txt" , n = 2)[[2]]

load_objects(path = "../../2021/Objects")
```

# Prep 2021

## Create directories

```{r 2020_dirs}
(dirs_2020 <- list.dirs(path = "../../2020", full.names = FALSE, recursive = FALSE))
```

```{r 2021_main_dirs}
# dir.create("../../2021")

dirs_2021 <- paste0("../../2021/", dirs_2020[c(1:10, 12:14)])
sapply(dirs_2021, dir.create)
```

```{r 2021_sub_dirs}
dir.create("../../2021/Raw genotypes/Strata")

# dirs_rubias_2021 <- paste0("../../2021/rubias/", c("baseline", "mixture", "output"))
# sapply(dirs_rubias_2021, dir.create)

dirs_BAYES_2021 <- paste0("../../2021/BAYES/", c("Baseline", "Control", "Mixture", "Output"))
sapply(dirs_BAYES_2021, dir.create)
```

## Copy 2020 files

Even though we are using the 2020 baseline, I'm grabbing the 2018 objects.
```{r BAYES_baseline_objects_copy_paste}
baseline_objects_2018 <- list.files(path = "../../../Baseline/2018/Objects/", pattern = ".txt", full.names = TRUE)[-c(6:7)]

file.copy(from = baseline_objects_2018, to = "../../2021/Objects/")
```

**Make sure to get the 2020 develop baseline!!!**
```{r BAYES_baseline_copy_paste}
file.copy(from = "../../../Baseline/2020/BAYES_baseline/Chignik16pops22RAD_develop.bse", 
          to = "../../2021/BAYES/Baseline/")
```

```{r 2020_objects_copy_paste}
objects_2020 <- c("../../2020/Objects/chignik_colors.txt",
                  "../../2020/Objects/Inits_16pops.txt",
                  "../../2020/Objects/loci24_RAD.txt",
                  "../../2020/Objects/WASSIPSockeyeSeeds.txt")

file.copy(from = objects_2020, to = "../../2021/Objects/")
```

```{r 2020_estimates_copy_paste}
estimates_objects_2020 <- list.files(path = "../../2020/Estimates objects/", pattern = "chignik_2020_dates", full.names = TRUE)

file.copy(from = estimates_objects_2020, to = "../../2021/Estimates objects/")
```

```{r 2020_estimates_csv_copy_paste}
estimates_csv_objects_2020 <- list.files(path = "../../2020/Estimates tables/", pattern = "BAYES", full.names = TRUE)

file.copy(from = estimates_csv_objects_2020, to = "../../2021/Estimates tables/")
```

Copy over the 2020 baseline genotype files, even though they are in the new *GCL 2.0* format off of the *develop* branch, and this entire script is still using the older *v1.12.0-static* branch.
```{r}
baseline_genotypes <- list.files(path = "../../../Baseline/2020/Baseline genotypes develop/", full.names = TRUE)

file.copy(from = baseline_genotypes, to = "../../2021/Baseline genotypes/")
```

We aren't using *rubias* so why bother?
```{r}
# rubias_baseline <- list.files(path = "../../2020/rubias/baseline/", full.names = TRUE)
# 
# file.copy(from = rubias_baseline, to = "../../2021/rubias/baseline/")
```

Make sure to get the 2020 develop baseline
```{r}
file.copy(from = "../../../Baseline/2020/sample_size_qa_baseline_develop.csv", to = "../../2021")
```

Grab logistic coefficients
```{r}
file.copy(from = "../../2020/logistic_coefficients.csv", to = "../../2021")
```

And grab the 2020 estimates summary
```{r}
file.copy(from = "../../2020/2020 Chignik Estimates Summary.xlsx", to = "../../2021")
```

And grab the 2020 preseason average
```{r}
file.copy(from = "../../2020/2020_preseason_average_GSI_model.csv", to = "../../2021")
```


# Average model 2010-2021

From Lukas and Dan Schindler's code with 2010-2020 data and `preseason = TRUE`
```{r}
# stan_model <- read_csv("V:/Documents/4_Westward/Sockeye/Chignik GSI Inseason Model - Schindler/bayesian_hierarchical_transition_model/current_year_curves.csv") %>% 
#   rename(julian = X1, chignik_late_prop = V1) %>% 
#   mutate(date = as.Date(julian, origin = "2020-12-31")) %>% 
#   select(julian, date, chignik_late_prop) %>% 
#   write_csv(path = "../../2021/2021_preseason_average_GSI_model_stan.csv")
```


# Run 1

Find and replace "run1"
```{r run1_setup}
sillys <- "SCHIG21"
strata <- 1
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Create LocusControl

```{r 2021_locuscontrol}
CreateLocusControl.GCL(locusnames = loci24_RAD, username = .username, password = .password)
save_objects("LocusControl", path = "../../2021/Objects/")
```

## Read genotypes

Sample size should be multiples of 190.
```{r run1_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run1_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1, 
                       begin_date = as.Date(x = c("2021-06-25")), 
                       end_date = as.Date(x = c("2021-06-25")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run1_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run1_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run1_n_locus)
round(apply(original_sillys_strata_2021_run1_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run1_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2021_run1}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run1}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run1}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run1}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run1}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run1}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Prior

```{r}
mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv")

mod_avg <- mod_avg %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y"))

chignik_late_prior_1 <- mod_avg %>%
  filter(date == as.Date("2021-06-30")) %>% 
  pull(chignik_late_prop_adfg)
```

```{r prior_run1}
chignik_2021_start_prior_weights <- c(1 - chignik_late_prior_1, chignik_late_prior_1)

chignik_1_2021_prior <- 
  Prior.GCL(
    groupvec = groupvec16, 
    groupweights = chignik_2021_start_prior_weights, 
    minval = 0.01
  )
save_objects(objects = "chignik_1_2021_prior", path = "../../2021/Objects")
```

### Control files

```{r control_run1}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_1_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run1}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run1}
SCHIG21_1_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_1_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run1}
trace_plot.f <- function(estimate_obj) {
  par(mfrow = c(2, 1), mar = c(4.1, 4.1, 2.1, 2.1))
  
  plot(estimate_obj[[2]][[1]][seq(from = 1, to = 100000, by = 10), 1], type = "l", ylim = c(0, 1), ylab = "", main = "Black Lake", xlab = "")
  abline(v = seq(from = 0, to = 10000, by = 2000))
  par(mar = c(4.1, 4.1, 2.1, 2.1))
  plot(estimate_obj[[2]][[1]][seq(from = 1, to = 100000, by = 10), 2], type = "l", ylim = c(0, 1), ylab = "", main = "Chignik Lake", xlab = "Repetitions", cex.lab = 1.2)
  abline(v = seq(from = 0, to = 10000, by = 2000))
  mtext(text = "Posterior", side = 2, outer = TRUE, line = -1, cex = 1.2)
  
  print(estimate_obj[[1]][[1]][, "GR"])
}

save_objects(objects = "trace_plot.f", path = "../../2021/Objects/")
trace_plot.f(estimate_obj = SCHIG21_1_estimates)
```

Add to summary
```{r summary_run1}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run1}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run1}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run1}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run1}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run2}
chignik_2_2021_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG21_1_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_2_2021_prior", path = "../../2021/Objects/")
```

## Save
```{r save_run1}
save.image("../../2021/chignik_2021_run1.RData")
```


# Run 2

Find and replace "run2"
```{r run2_setup}
sillys <- "SCHIG21"
strata <- 2
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run2_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run2_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2021-06-25", "2021-07-01")), 
                       end_date = as.Date(x = c("2021-06-25", "2021-07-01")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run2_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run2_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run2_n_locus)
round(apply(original_sillys_strata_2021_run2_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run2_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2021_run2}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run2}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run2}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run2}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run2}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run2}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Control files

```{r control_run2}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_2_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run2}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run2}
SCHIG21_2_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_2_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run2}
trace_plot.f(estimate_obj = SCHIG21_2_estimates)
```

Add to summary
```{r summary_run2}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run2}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run2}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run2}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run2}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run3}
chignik_3_2021_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG21_2_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_3_2021_prior", path = "../../2021/Objects/")
```

## Save
```{r save_run2}
save.image("../../2021/chignik_2021_run2.RData")
```

# Run 3

Find and replace "run3"
```{r run3_setup}
sillys <- "SCHIG21"
strata <- 3
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run3_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run3_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07")), 
                       end_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run3_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run3_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run3_n_locus)
round(apply(original_sillys_strata_2021_run3_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run3_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworth genotypes.
```{r qa_setup_2021_run3}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run3}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run3}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run3}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run3}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run3}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Control files

```{r control_run3}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_3_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run3}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      silly == "SCHIG21_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run3}
SCHIG21_3_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_3_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run3}
trace_plot.f(estimate_obj = SCHIG21_3_estimates)
```

Add to summary
```{r summary_run3}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run3}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run3}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run3}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run3}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run4}
chignik_4_2021_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG21_3_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_4_2021_prior", path = "../../2021/Objects/")
```

## Save
```{r save_run3}
save.image("../../2021/chignik_2021_run3.RData")
```

# Run 4

Find and replace "run4"
```{r run4_setup}
sillys <- "SCHIG21"
strata <- 4
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run4_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run4_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-13")), 
                       end_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-14")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run4_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run4_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run4_n_locus)
round(apply(original_sillys_strata_2021_run4_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run4_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2021_run4}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run4}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run4}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run4}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run4}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run4}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Control files

```{r control_run4}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_4_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run4}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      silly == "SCHIG21_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run4}
SCHIG21_4_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_4_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run4}
trace_plot.f(estimate_obj = SCHIG21_4_estimates)
```

Add to summary
```{r summary_run4}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run4}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run4}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run4}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run4}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run5}
chignik_5_2021_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG21_4_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_5_2021_prior", path = "../../2021/Objects/")
```

## Save
```{r save_run4}
save.image("../../2021/chignik_2021_run4.RData")
```

# Run 5

Find and replace "run5"
```{r run5_setup}
sillys <- "SCHIG21"
strata <- 5
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run5_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run5_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-13", "2021-07-19")), 
                       end_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-14", "2021-07-20")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run5_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run5_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run5_n_locus)
round(apply(original_sillys_strata_2021_run5_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run5_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2021_run5}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run5}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run5}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run5}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run5}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run5}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Control files

```{r control_run5}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_5_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run5}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      silly == "SCHIG21_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run5}
SCHIG21_5_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_5_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run5}
trace_plot.f(estimate_obj = SCHIG21_5_estimates)
```

Add to summary
```{r summary_run5}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run5}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run5}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run5}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run5}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```


## Prior for next round
```{r prior_run6}
chignik_6_2021_prior <- Prior.GCL(groupvec = groupvec16, groupweights = SCHIG21_5_estimates[[1]][[1]][, 1], minval = 0.01)
save_objects(objects = "chignik_6_2021_prior", path = "../../2021/Objects/")
```

## Save
```{r save_run5}
save.image("../../2021/chignik_2021_run5.RData")
```

# Run 6

Find and replace "run6"
```{r run6_setup}
sillys <- "SCHIG21"
strata <- 6
(sillys_strata <- paste(sillys, strata, sep = "_"))
```

## Read genotypes

Sample size should be multiples of 190.
```{r run6_read_genotypes}
LOKI2R.GCL(sillyvec = sillys, username = .username, password = .password)
save_sillys(sillyvec = sillys, path = "../../2021/Raw genotypes/")

sapply(sillys, function(silly) {get(paste0(silly, ".gcl"))$n} )
sapply(sillys, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```

## Create strata

```{r run6_strata}
# Function to pool by sample date
PoolCollectionsByDateDF <- function(silly, date.df, loci) {
  sapply(silly, function(mix) {
    mix.dates <- unique(as.Date(get(paste(mix, ".gcl", sep = ''))$attributes$CAPTURE_DATE))
    by(data = date.df, INDICES = date.df$strata, function(x) {
      IDs <- AttributesToIDs.GCL(silly = mix, attribute = "CAPTURE_DATE", matching = mix.dates[mix.dates >= x$begin_date & mix.dates <= x$end_date])
      IDs <- list(na.omit(IDs))
      names(IDs) <- mix
      PoolCollections.GCL(collections = mix, loci = loci, IDs = IDs, newname = paste(mix, as.character(x$strata), sep = "_"))
      list("First Last Fish" = range(as.numeric(unlist(IDs))), "n" = get(paste(mix, "_", as.character(x$strata), ".gcl", sep = ''))$n)
    } )
  }, simplify = FALSE, USE.NAMES = TRUE)
}

# Strata dates
date_2021.df <- tibble(strata = 1:strata, 
                       begin_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-13", "2021-07-19", "2021-07-26")), 
                       end_date = as.Date(x = c("2021-06-25", "2021-07-01", "2021-07-07", "2021-07-14", "2021-07-20", "2021-07-27")))

# Pool
PoolCollectionsByDateDF(silly = sillys, date.df = date_2021.df, loci = loci24_RAD)

# Save
sillys_strata_2021 <- setdiff(
  str_replace(string = objects(pattern = "\\.gcl"), 
              pattern = "\\.gcl", 
              replacement = ''),
  sillys)
save_objects(objects = "sillys_strata_2021", path = "../../2021/Objects")
save_sillys(sillyvec = sillys_strata, path = "../../2021/Raw genotypes/Strata/")

# Verify
sapply(sillys_strata, function(silly) {table(get(paste0(silly, ".gcl"))$attributes$CAPTURE_DATE, useNA = "always")} )
```


## Data QA

Check loci failure rate.
```{r run6_QA_loci}
## Get sample size by locus
original_sillys_strata_2021_run6_n_locus <- SampSizeByLocus.GCL(sillyvec = sillys_strata, loci = loci24_RAD)
min(original_sillys_strata_2021_run6_n_locus)
round(apply(original_sillys_strata_2021_run6_n_locus, 1, function(locus) {min(locus) / max(locus)}), 2)

original_sillys_strata_percent_locus <- apply(original_sillys_strata_2021_run6_n_locus, 1, function(row) {row / max(row)} )
which(apply(original_sillys_strata_percent_locus, 2, min) < 0.8)  # no re-runs!

# Genotpying percentage by locus and strata
require(lattice)
new.colors <- colorRampPalette(c("black", "white"))
levelplot(t(original_sillys_strata_percent_locus), 
          col.regions = new.colors, 
          at = seq(from = 0, to = 1, length.out = 100), 
          main = "% Genotyped", xlab = "SILLY", ylab = "Locus", 
          scales = list(x = list(rot = 90)), 
          aspect = "fill")  # aspect = "iso" will make squares
```


Perform standard data QA processes to filter out untrustworthy genotypes.
```{r qa_setup_2021_run6}
sillys_strata_2021_n <- tibble(silly = sillys_strata_2021) %>% 
  mutate(genotyped = sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Missing

Remove individuals missing >=20% of genotypes (i.e. the 80% rule).
```{r qa_missing_2021_run6}
sillys_strata_2021_MissLoci <- RemoveIndMissLoci.GCL(sillyvec = sillys_strata_2021, proportion = 0.8)
save_objects("sillys_strata_2021_MissLoci", "../../2021/Objects/")

# show individuals removed
sillys_strata_2021_MissLoci[sillys_strata_2021_MissLoci != "None"]

sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(missing = genotyped - sapply(silly, function(x) get(paste0(x, ".gcl"))$n))
```

### Duplicate

Remove duplicate individuals within the same collection. Typically we specify *duplicates* as a pair of individuals that share >=95% of genotypes. Once a pair of *duplicates* is identified, we keep the individual with the most genotypes and remove the other.
```{r qa_duplicate_2021_run6}
sillys_strata_2021_DuplicateCheck95MinProportion <-
  CheckDupWithinSilly.GCL(
    sillyvec = sillys_strata_2021,
    loci = loci24_RAD,
    quantile = NULL,
    minproportion = 0.95
  )

(sillys_strata_2021_DuplicateCheckReportSummary <-
  sapply(sillys_strata_2021, function(x)
    sillys_strata_2021_DuplicateCheck95MinProportion[[x]]$report, simplify = FALSE))

sillys_strata_2021_RemovedDups <-
  RemoveDups.GCL(sillys_strata_2021_DuplicateCheck95MinProportion)

save_objects(
  c("sillys_strata_2021_DuplicateCheckReportSummary", "sillys_strata_2021_RemovedDups"),
  "../../2021/Objects/"
)

# show individuals removed
sillys_strata_2021_RemovedDups[sillys_strata_2021_RemovedDups != "Nothing Removed"]

sillys_strata_2021_n <- sillys_strata_2021_n %>%
  mutate(duplicate = genotyped - missing - sapply(silly, function(x)
    get(paste0(x, ".gcl"))$n))
```

### Final

How many fish did we end up with in our final baseline? Save final genotypes.
```{r qa_final_2021_run6}
(sillys_strata_2021_n <- sillys_strata_2021_n %>% 
  mutate(final = sapply(silly, function(x) get(paste0(x, ".gcl"))$n)))

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


## Combine loci

Need to combine GDPH and MHC markers
```{r combine_loci_run6}
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_MHC2_251", "One_MHC2_190"), delim = ".", update = TRUE)
CombineLoci.GCL(sillyvec = sillys_strata, markerset = c("One_GPDH2", "One_GPDH"), delim=".", update = TRUE)
```


## BAYES

### Mixture format

```{r mix_run6}
MixtureFortran <- 
  CreateMixture.GCL(
    sillys = sillys_strata, 
    loci = loci22_RAD, 
    IDs = NULL, 
    mixname = sillys_strata,
    dir = "../../2021/BAYES/Mixture",
    type = "BAYES",
    PT = FALSE
  )
save_objects(objects = "MixtureFortran", path = "../../2021/Objects")
```

### Control files

```{r control_run6}
CreateControlFile.GCL(
  sillyvec = Chignik16pops, 
  loci = loci22_RAD, 
  mixname = sillys_strata, 
  basename = "Chignik16pops22RAD", 
  suffix = "", 
  nreps = 40000, 
  nchains = 5,
  groupvec = groupvec16, 
  priorvec = chignik_6_2021_prior, 
  initmat = Inits_16pops, 
  dir = "../../2021/BAYES/Control",
  seeds = WASSIPSockeyeSeeds, 
  thin = c(1, 1, 100),
  mixfortran = MixtureFortran, 
  basefortran = BaselineFortran, 
  switches = "F T F T T T F"
) 

dir.create(paste0("../../2021/BAYES/Output/", sillys_strata))
```

## Summarize output

We lost two fish in *BAYES* from run 1  and one in run 3 due to an unrecognized allele (CCCT for One_GPDH2.One_GPDH, evidently no one calls blues for One_GPDH2...). Need to update that in the samples size table.

```{r samples_size_update_run6}
(
  sillys_strata_2021_n <- sillys_strata_2021_n %>%
    mutate(final = sapply(silly, function(x)
      get(paste0(
        x, ".gcl"
      ))$n)) %>%
    mutate(final = case_when(
      silly == "SCHIG21_1" ~ as.integer(final - 2),
      silly == "SCHIG21_3" ~ as.integer(final - 1),
      TRUE ~ final
    ))
)

save_objects(objects = "sillys_strata_2021_n", path = "../../2021/Objects/")
write_csv(sillys_strata_2021_n, "../../2021/Tables/sillys_strata_2021_n.csv")
```


```{r estimates_run6}
SCHIG21_6_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = TRUE)  # Yes, I want the Posterior so I can look at trace plot.

save_objects(objects = "SCHIG21_6_estimates", path = "../../2021/Estimates objects/")
```

Create function to view traceplot
```{r traceplot_run6}
trace_plot.f(estimate_obj = SCHIG21_6_estimates)
```

Add to summary
```{r summary_run6}
SCHIG21_estimates <- 
  CustomCombineBAYESOutput.GCL(
    groupvec = 1:2, 
    groupnames = ChignikGroups, 
    maindir = "../../2021/BAYES/Output", 
    mixvec = sillys_strata_2021,
    prior = "", 
    ext = "RGN", 
    nchains = 5, 
    burn = 0.5, 
    alpha = 0.1, 
    PosteriorOutput = FALSE)

save_objects(objects = "SCHIG21_estimates", path = "../../2021/Estimates objects/")
```

Bind everything together
```{r summary_all_year_run6}
chignik_2021.bayes <- bind_rows(sapply(sillys_strata_2021, function(mix) {
  as_tibble(cbind(SCHIG21_estimates[[mix]], "repunit" = ChignikGroups, silly = mix))
}, simplify = FALSE))
```

Get sample sizes and dates for each strata to calculate average date
```{r attributes_run6}
SCHIG21_attributes <-
  as_tibble(bind_rows(lapply(sillys_strata_2021, function(silly) {
    cbind(get(paste0(silly, ".gcl"))$attributes, "new_silly" = silly)
  })))

date_avg <- SCHIG21_attributes %>% 
  separate(col = new_silly, into = c("new_silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(julian = yday(CAPTURE_DATE)) %>% 
  group_by(strata) %>%
  summarize(avg_date = mean(julian))
```

Final summary with dates
```{r summary_all_year_dates_run6}
chignik_2021_dates.bayes <- chignik_2021.bayes %>% 
  select(silly, repunit, mean, sd, median, `5%`, `95%`, `P=0`, GR) %>% 
  separate(col = silly, into = c("silly", "strata"), sep = "_") %>% 
  mutate(strata = as.integer(strata)) %>% 
  mutate(repunit = factor(x = repunit, levels = ChignikGroups)) %>% 
  mutate(mean = as.double(mean)) %>% 
  mutate(sd = as.double(sd)) %>% 
  mutate(median = as.double(median)) %>% 
  mutate(`5%` = as.double(`5%`)) %>% 
  mutate(`95%` = as.double(`95%`)) %>% 
  mutate(`P=0` = as.double(`P=0`)) %>% 
  mutate(GR = as.double(GR)) %>% 
  left_join(date_avg, by = "strata") %>% 
  mutate(date = as.Date(avg_date, origin = "2020-12-31")) %>% 
  left_join(date_2021.df, by = "strata")

save_objects(objects = "chignik_2021_dates.bayes", path = "../../2021/Estimates objects/")
write_csv(x = chignik_2021_dates.bayes, path = "../../2021/Estimates tables/Chignik 2021 BAYES Estimates.csv")
```

```{r model_average_run6}
(mod_avg <- read_csv(file = "../../2021/2021_preseason_average_GSI_model.csv") %>% 
  mutate(date = as.Date(date, format = "%m/%d/%Y")))
```

## Save
```{r save_run6}
save.image("../../2021/chignik_2021_run6.RData")
```

